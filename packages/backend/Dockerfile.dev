FROM python:3.9.10-slim-buster
# Adding backend directory to make absolute filepaths consistent across services
WORKDIR /workspace/app
# Install Python dependencies
COPY requirements.txt /workspace/app
RUN  \
    apt-get update -y && \
    export DEBIAN_FRONTEND=noninteractive &&\
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends postgresql postgresql-contrib gcc musl-dev \
    # needed for uwsgi
    python3-dev && \
    apt-get clean -y && \
    pip3 install --upgrade pip -r requirements.txt
# Add the rest of the code
COPY . /workspace/app
COPY ./scripts/ /workspace/
# Make port 8000 available for the app
ENV PORT 8000
EXPOSE 8000
ENV UWSGI_HTTP=:8000 UWSGI_MASTER=1 UWSGI_HTTP_AUTO_CHUNKED=1 UWSGI_HTTP_KEEPALIVE=1 UWSGI_LAZY_APPS=1 UWSGI_WSGI_ENV_BEHAVIOR=holy
# Be sure to use 0.0.0.0 for the host within the Docker container,
# otherwise the browser won't be able to find it
RUN ["chmod", "+x", "/workspace/entrypoint-dev.sh"]
CMD [ "/workspace/entrypoint-dev.sh" ]
