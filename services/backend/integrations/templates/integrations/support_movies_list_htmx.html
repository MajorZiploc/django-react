<div id="movies">
  {% for movie in movies %}
  <div>
    {{ forloop.counter }} {{ movie.title }} {{ movie.genre }}
    <button
      class="btn btn-secondary"
      hx-delete="{% url 'integrations:support_delete_movie_htmx' movie.id %}"
      hx-trigger="click"
      hx-confirm="Are you sure you want to delete this movie?"
      hx-target="#movies"
      hx-swap="outerHTML"
    >
      Delete?
    </button>
    <form>
      <select name="genre" id="genre-select-{{ movie.id }}">
        {% for genre in genres %}
        <option value="{{genre.id}}" {% if genre == cur_genre %}selected="selected"{% endif %}>
          {{genre.label|capfirst}}
        </option>
        {% endfor %}
      </select>
      <button
        class="btn btn-primary"
        hx-post="{% url 'integrations:support_save_movie_htmx' movie.id %}"
        hx-trigger="click"
        hx-target="#movies"
        hx-confirm="Are you sure you want to save this movie?"
        hx-swap="outerHTML"
      >
        Save
      </button>
    </form>
  </div>
  {% endfor %}
  <button
    class="btn btn-primary"
    hx-get="{% url 'integrations:support_load_genres' %}"
    hx-trigger="click"
    hx-target="#genre-list"
    hx-swap-oob="outerHTML"
  >
    Load Genres
  </button>

  <div id="genre-list">
    <!-- This div will be updated with the response from the support_load_genres view -->
  </div>
  <script>
    console.log('support_movies_list_htmx');

    function updateSelectOptions(data) {
      const selectOptionsList = document.querySelectorAll('select[id*=genre-select-]');
      for (const selectOptions of selectOptionsList) {
        selectOptions.innerHTML = ''; // Clear existing options
        data.genres.forEach(function (genre) {
          var option = document.createElement('option');
          option.value = genre.id;
          option.text = genre.label;
          selectOptions.appendChild(option);
        });
      }
    }

    document.body.addEventListener('htmx:afterSwap', function (event) {
      if (event.target.id === 'genre-list') {
        var responseData = JSON.parse(document.getElementById('genre-list').innerText);
        updateSelectOptions(responseData);
      }
    });
  </script>
</div>
